\chapter{Interaktionsprotokolle}
\label{cha:Interaktionsprotokolle}

\section{Dienst 1 -- Statische Daten}
\label{sec:Interaktionsprotokolle:Dienst1}

\subsection{Abfrage Buchungsziele}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{BookingTargetsInfo}{}

\begin{call}{ris}{BookingTargetsInfoRequest(ProviderID*)}{fvs}{BookingTargetsInfos}

\end{call}

\end{sdblock}

\end{sequencediagram}\\
\hfill\textit{* optional}
\end{center}
\smallskip

Als Basis für die Informationskopplung dient der Austausch von sogenannten Buchungszielen. Buchungsziele sind eine logische Repräsentation von einem oder mehreren Fahrzeugen mit gemeinsamen Eingeschaften, wie z.B. vom gleichen Anbieter bereitgestellt, gleicher Fahrzeugtyp und gleiche Verleihstation. Diese Eigenschaften sind statisch. Um nur Informationen zu Buchungszielen eines bestimmten Anbieters zu erhalten, kann nach \texttt{ProviderID} gefiltert werden.

\subsection{Abfrage Änderungen Buchungszielen}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{ChangedProviders}{}

\begin{call}{ris}{ChangedProvidersRequest}{fvs}{ChangedProvidersIDs}
\end{call}

% \begin{messcall}{ris}{Asynchrone Nachricht}{fvs}
% \end{messcall}

\end{sdblock}
\end{sequencediagram}
\end{center}
\smallskip

Um nicht-intervallweise alle Buchungszielinformationen übertragen zu müssen, kann mit dem Aufruf \texttt{ChangedProviders} angefragt werden, bei welchem Anbieter sich Änderungen seit einem bestimmten Zeitpunkt, vorgegeben durch den Parameter \texttt{timestamp}, ergeben haben. Rückgegeben wird eine \texttt{ProviderID}, die wiederum bei \texttt{BookingTargetsInfo} als Parameter übergeben werden kann.

\section{Dienst 2 -- Verfügbarkeitsauskunft}
\label{sec:Interaktionsprotokolle:Dienst2}

\subsection{Abfrage Verfügbarkeit}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{AvailabilityRequest}{}

\begin{call}{ris}{BookingTargetList/Circle/GeoRectangle, TimePeriod}{fvs}{BookingTargetList}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

Um die konkreten Verfügbarkeiten abzufragen, sendet das RIS eine Anfrage die entweder eine Liste mit Buchungszielen oder ein geographisches Gebiet in Form einer Umgebungssuche (Circle) oder eines Rechtecks  (GeoRectangle) und eine geünschte Zeitperiode enthält. Ohne Angabe wird die Verfügbarkeit von allen Buchungszielen zurückgegeben. Als Antwort sendet das FVS eine Liste mit Buchungszielen und deren Verfügbarkeiten zurück.


\subsection{Abfrage aktuelle Stationskapazität (Dienst 2a)}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{PlaceAvailability}{}

\begin{call}{ris}{PlaceIDList/Circle/GeoRectangle}{fvs}{PlaceAvailabilityList}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip
Das RIS kann die aktuellen Kapazitäten, bspw. zur Kartendarstellung, von Verleihstation anfragen. Hierzu wird eine Liste mit Stations IDs oder ein Gebiet übermittelt und eine Liste mit Stationen und deren aktuelle Anzahl verfügbarer Fahrzeuge zurückgegeben.


\section{Dienst 3 -- Verfügbarkeitsabonnement}
\label{sec:Interaktionsprotokolle:Dienst3}

\subsection{Verfügbarkeitsabonnement}
\label{subsec:Interaktionsprotokolle:Dienst3}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{AvailabilitySubscription}{}

\begin{call}{ris}{BookingTargetID, (Unsubscription)*, EventHorizon}{fvs}{}
\end{call}

\end{sdblock}

\begin{sdblock}{AvailabilityPushMessage}{}

\begin{mess}{fvs}{AvailabilityChange}{ris}
\end{mess}

\begin{mess}{fvs}{AvailabilityChange}{ris}
\end{mess}
\begin{mess}{fvs}{AvailabilityChange}{ris}
\end{mess}
\begin{mess}{fvs}{...}{ris}
\end{mess}
\end{sdblock}


\begin{sdblock}{CompleteAvailability}{}

\begin{call}{ris}{MaxTargets}{fvs}{MessageBlockID, (Last)*, BookingTargetList}
\end{call}

\end{sdblock}



\end{sequencediagram}
\end{center}
\smallskip

Das RIS kann Informationen zu Buchungszielen abonnieren, um unmittelbar über Änderungen von Verfügbarkeiten informiert zu werden. Dies dient im Wesentlichen dazu, Reiseauskünfte ohne zusätzliche (synchrone) Anfrage an das FVS beantworten zu können. 

Durch die initiale Anfrage \texttt{AvailabilitySubscriptionRequest} wird ein Abonnment (subscription) begonnen. Hierzu übergibt das RIS die entsprechende Buchungsziel ID (BookingTargetID). Durch das Setzten des Flags \texttt{Unsubscription}, kann ein Abonnement storniert werden. Bei Änderungen an Verfügbarkeiten überträgt das FVS asynchron \texttt{AvailabilityPushMessage}s. Diese werden über den gleichen Kommunikationskanal geliefert über den das Abonnement erstellt wurde. Beim Beenden des Kommunikationskanals werden alle Abonnements hinfällig.

Zur anfänglichen Synchronsierung aller Verfügbarkeiten kann das RIS die Funktion \texttt{CompleteAvailabilityRequest} aufrufen. 





\subsection{Stationskapazitätabonement (Dienst 3a)}
\label{subsec:Interaktionsprotokolle:Dienst3a}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{PlaceAvailabilitySubscription}{}

\begin{call}{ris}{PlaceID, (Unsubscription)*}{fvs}{}
\end{call}

\end{sdblock}

\begin{sdblock}{PlaceAvailabilityPushMessage}{}

\begin{mess}{fvs}{PlaceAvailability}{ris}
\end{mess}

\begin{mess}{fvs}{PlaceAvailability}{ris}
\end{mess}
\begin{mess}{fvs}{PlaceAvailability}{ris}
\end{mess}
\begin{mess}{fvs}{...}{ris}
\end{mess}
\end{sdblock}


\begin{sdblock}{CompletePlaceAvailability}{}

\begin{call}{ris}{MaxPlaces}{fvs}{MessageBlockID, (Last)*, PlaceAvailabilityList}
\end{call}

\end{sdblock}



\end{sequencediagram}
\end{center}
\smallskip

Das RIS kann die Kapazitätsinformation von Stationen abonnieren. Der Interaktionsablauf ist analog zu \cref{subsec:Interaktionsprotokolle:Dienst3}.


\section{Dienst 4 -- Buchung / Buchungsänderung}
\label{sec:Interaktionsprotokolle:Dienst4}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{OpenSession*}{}

\begin{call}{ris}{}{fvs}{}
\end{call}

\end{sdblock}


\begin{sdblock}{Booking}{}

\begin{call}{ris}{BookingTargetID, TimePeriodProposal}{fvs}{BookingID, TimePeriod}
\end{call}

\end{sdblock}


\begin{sdblock}{ChangeBooking*}{}

\begin{call}{ris}{NewTimePeriodProposal / Cancel}{fvs}{TimePeriod}
\end{call}

\end{sdblock}

\begin{sdblock}{CloseSession*}{}

\begin{call}{ris}{}{fvs}{}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

Um im Kundenaufauftrag ein Fahrzeug zu Buchen, ist es erfoderlich, dass das RIS den Kunden gegenüber dem FVS authentifizert. Hierzu gibt es drei Möglichkeiten die in \cref{sec:Datenmodell:Auth} genauer dargestellt sind. In diesem Beispiel wird explizit eine Session mit \texttt{OpenSession} geöffnet und im Anschluss der Transkation durch \texttt{CloseSession} wieder geschlossen. Danach kann eine Buchung durch den Aufruf von \texttt{Booking} mit Angabe der entsprechenden Buchungsziel ID und einem Vorschlag für einen Zeitraum durchgeführt werden. \blockquote{Vorschlag} deshalb, da das FVS z.B. den Zeitraum auf das verwendete Buchungsraster ändern kann. Als Antwort wird die verwendete Buchungs ID (\emph{nicht Buchungsziel ID!}) und der tatsächliche Buchungszeitraum zurückgegeben. Die Buchungs ID kann zur Überwachung der Buchung verwendet werden (vgl. \cref{sec:Interaktionsprotokolle:Dienst5}). Zur Änderung des Buchungszeitraum oder zur Stornierung, kann \texttt{ChangeBooking} aufgerufen werden. Bei Änderung des Buchungsziels ist eine Stornierung und Neubuchung erforderlich. 


\section{Dienst 5 --  Buchungsabonnement}
\label{sec:Interaktionsprotokolle:Dienst5}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{BookingAlertSubscription}{}

\begin{call}{ris}{BookingID, (Unsubscription)*}{fvs}{}
\end{call}

\end{sdblock}

\begin{sdblock}{BookingAlertPushMessage}{}

\begin{mess}{fvs}{BookingChange}{ris}
\end{mess}

\begin{mess}{fvs}{BookingChange}{ris}
\end{mess}
\begin{mess}{fvs}{BookingChange}{ris}
\end{mess}
\begin{mess}{fvs}{...}{ris}
\end{mess}
\end{sdblock}


\begin{sdblock}{CompleteBookingAlert}{}

\begin{call}{ris}{MaxResults}{fvs}{MessageBlockID, (Last)*, BookingChangeList}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

Das RIS kann Änderungen an Buchung abonnieren, um diese Informationen dem Kunden weiterzugeben und ggfs. Alternativen anzubieten. Beispielsweise im Falle eines technisches Defekts an einem Fahrzeug, kann das FVS das RIS darüber informieren, dass die Buchung nicht mehr möglich ist. Ebenfalls ist es möglich, eine Buchung als \blockquote{wieder möglich} festzulegen. Endgültig storniert werden kann eine Buchung nur vom Endkunden.

Der Interaktionsablauf ist analog zu \cref{subsec:Interaktionsprotokolle:Dienst3}.


\section{Dienst 6 -- Preisauskunft}
\label{sec:Interaktionsprotokolle:Dienst6}

% \subsection{Abfrage Preis}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{OpenSession*}{}

\begin{call}{ris}{}{fvs}{}
\end{call}

\end{sdblock}

\begin{sdblock}{PriceInformation}{}

\begin{call}{ris}{BookingTargetID, TimePeriodProposal, Distance}{fvs}{Tariff}

\end{call}

\end{sdblock}

\begin{sdblock}{EndSession*}{}

\begin{call}{ris}{}{fvs}{}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

Mit einer Anfrage \texttt{PriceInformationRequest} kann das RIS beim FVS eine Preisauskunft auf Basis von Buchungsziel ID, Zeitraum und zurückzulegende Distanz anfragen. Falls vorher eine Authentifizierung des Endkunden z.B. durch \texttt{OpenSession} stattgefunden hat, ist die Preisanfrage entsprechend des Kundenvertrags zu beantworten.