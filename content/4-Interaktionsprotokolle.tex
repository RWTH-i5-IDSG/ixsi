\chapter{Interaction Sequences}
\label{cha:Interaktionsprotokolle}
This section provides an overview about the interaction schemes, used by IXSI. For simplification, these interaction schemes are described in interaction sequence diagrams without using the technical terms of function calls. In principal, two types of interactions are used: The simple and well-known request/response- or. query- interaction scheme, whereby every call of the client (in this case TIS) is followed by exactly one response of the server (VRS). Furthermore, the subscription-scheme, whereby one object is subscribed by the client once and updated continuously by the server. Hereby, the communication channel is opened all the time. 

\section{Overview}
The following sequence diagram gives an exemplary overview of information coupling, possibly enabled by IXSI. The used services are going to be described in detail in the following chapters. In this use case, a customer sets up a travel inquiry, books a respective travel and gets informed concerning relevant booking changes. 

In the first block \textit{Exchange booking targets}, the booking targets, provided by the \index{VRS}VRS are exchanged with the \index{TIS}TIS and relevant booking targets are subscribed (see. \cref{sec:Interaktionsprotokolle:Dienst1,sec:Interaktionsprotokolle:Dienst3}). This happens proactive, without involving the customer.
In block \textit{Travel Inquiry}, a customer sets up a travel inquiry with, e.g. his mobile device, on the TIS. Thereby, various rental vehicles are suitable for booking, whose availabilities are requested synchronously towards the VRS. For availabilities, the TIS additionally requests price information. As a result, the TIS provides a selection of possible routes/ connections to the customer. Because this is a communication triggered by the customer, a session which proceeds the queries is created implicitly. An anonymous session is used, because the customer did not register on his device beforehand.
In block \textit{Tarvel booking}, a customer has chosen a travel route and intends to book it. For this purpose, he registers on his mobile device, whereby a token is generated(Block \emph{Registration}). With this token, a (not anonymous) session is created, which proceeds the booking operation. For that, the TIS forwards booking reference and a time proposal to the VRS. This sends a booking confirmation, which is forwarded to the customer. In addition, the TIS subscribes the respective booking on the VRS.
In the last block \textit{Travel monitoring}, the customers gets informed concerning booking changes, which are received by the TIS, coming from the VRS.
\begin{center}
\begin{sequencediagram}


\newthread{customer}{:Customer}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}


\begin{sdblock}{Exchange booking targets}{Service 1, Service 3}

  \begin{call}{tis}{Request}{vrs}{List booking targets}
  \end{call}

  \begin{call}{tis}{Subscription booking targets}{vrs}{}
  \end{call}
  
  \begin{mess}{vrs}{Change booking target}{tis}
  \end{mess}
\end{sdblock}
\postlevel

\begin{sdblock}{Travel inquiry}{}
  \begin{call}{customer}{Travel inquiry}{tis}{Possible routes}

    \begin{sdblock}{Session (anonymous)}{Base service A}
        
        \begin{sdblock}{Availability information}{Service 2}
          \begin{call}{tis}{Availability information booking targets,  time span}{vrs}{Possible booking targets}
          \end{call}
        \end{sdblock}

        \begin{sdblock}{Price inquiry}{Service 6}
          \begin{call}{tis}{Price information booking targets, time span, distance}{vrs}{Price}
          \end{call}
        \end{sdblock}
      
    \end{sdblock}
  \end{call}
\end{sdblock}

\end{sequencediagram}

\smallskip


\begin{sequencediagram}
\newthread{customer}{:Customer}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Registration}{}

  \begin{call}{customer}{Registration}{tis}{Token}
        
    \begin{sdblock}{Token generation}{Base service C}


      \begin{call}{tis}{User name, password}{vrs}{Token}
      \end{call}

    \end{sdblock}

  \end{call}
\end{sdblock}
\postlevel

\begin{sdblock}{Travel booking}{}

  \begin{call}{customer}{Route selection, token}{tis}{Booking confirmation}
    \begin{sdblock}{Session}{Base service A}

      \begin{sdblock}{Vehicle booking}{Service 4}
        \begin{call}{tis}{Booking target reference, time span proposal}{vrs}{booking reference, time span}
        \end{call}
      \end{sdblock}
      
    \end{sdblock}
    
  \end{call}
    
    \begin{sdblock}{Booking subscription}{Service 5}

      \begin{call}{ris}{Booking reference}{vrs}{}
      \end{call}

    \end{sdblock}



\end{sdblock}

\postlevel

\begin{sdblock}{Travel monitoring}{Service 5}
\postlevel
  \begin{mess}{vrs}{Booking change}{tis}
  \end{mess}

  \begin{mess}{tis}{Booking change}{customer}
  \end{mess}
  
\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip




\section{Service 1 -- Static Data}
\label{sec:Interaktionsprotokolle:Dienst1}

\subsection*{Booking Target Query}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Booking target exchange}{}

\begin{call}{tis}{Booking target query(Provider*)}{vrs}{Booking target list}

\end{call}

\end{sdblock}

\end{sequencediagram}\\
\hfill\textit{* optional}
\end{center}
\smallskip

Basis for information coupling is the exchange of booking targets. Booking targets are a logical representation of one or several vehicles with common characteristics, e.g., provided by the same provider, same vehicle type or same rental station. These characteristics are statically. To receive booking target information concerning a certain provider solely, it is possible to filter concerning the respective provider. The transmission is initiated by the TIS.

\subsection*{Booking Target Change Query}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Booking Target Changes}{}

\begin{call}{tis}{Booking target change query}{vrs}{Provider list}
\end{call}

% \begin{messcall}{ris}{Asynchrone Nachricht}{fvs}
% \end{messcall}

\end{sdblock}
\end{sequencediagram}
\end{center}
\smallskip

To avoid the transmission of all booking information per interval, with the help of the query \texttt{ChangedProviders} it is possible to inquire the provider, related to changes since a specific point in time, set by the parameter \texttt{timestamp}. A provider reference is returned, which in turn can be transferred as a parameter by the function call \texttt{Booking\-TargetsInfo}. 

\section{Service 2 -- Availability Information}
\label{sec:Interaktionsprotokolle:Dienst2}

\subsection*{Availability Query}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Availability Information}{}

\begin{call}{tis}{Booking targets/ area, time span}{vrs}{Booking targets}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

Um die konkreten Verfügbarkeiten abzufragen, sendet das RIS eine Anfrage die entweder eine Liste mit Buchungszielen oder ein geographisches Gebiet in Form einer Umgebungssuche oder als Rechteck und eine gewünschte Zeitperiode enthält. Ohne Angabe wird die Verfügbarkeit von allen Buchungszielen zurückgegeben. Als Antwort sendet das FVS eine Liste mit Buchungszielen und deren Verfügbarkeiten zurück.


\subsection*{Abfrage aktuelle Stationskapazität (Dienst 2a)}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{Abfrage Stationskapazität}{}

\begin{call}{ris}{Referenz Stationen / Gebiet}{fvs}{Liste Stationskapazitäten}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip
Das RIS kann die aktuellen Kapazitäten, bspw. zur Kartendarstellung, von Verleihstation anfragen. Hierzu wird eine Liste mit Standort IDs oder ein Gebiet übermittelt und eine Liste mit Standorten und deren aktueller Anzahl verfügbarer Fahrzeuge zurückgegeben.


\section{Dienst 3 -- Verfügbarkeitsabonnement}
\label{sec:Interaktionsprotokolle:Dienst3}

\subsection*{Verfügbarkeitsabonnement}
\label{subsec:Interaktionsprotokolle:Dienst3}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{Verfügbarkeit abonnieren}{}

\begin{call}{ris}{Buchungsziel, (Kündigung)*, Zeithorizont}{fvs}{}
\end{call}

\end{sdblock}
\postlevel
\begin{sdblock}{Verfügbarkeitsaktualisierungen}{}

\begin{mess}{fvs}{Verfügbarkeitsaktualisierung}{ris}
\end{mess}
\begin{mess}{fvs}{Verfügbarkeitsaktualisierung}{ris}
\end{mess}
\begin{mess}{fvs}{Verfügbarkeitsaktualisierung}{ris}
\end{mess}
\begin{mess}{fvs}{...}{ris}
\end{mess}
\end{sdblock}

\postlevel
\begin{sdblock}{Gesamte Verfügbarkeit}{}

\begin{call}{ris}{Maximale Anzahl Objekte}{fvs}{Buchungsziele}
\end{call}

\end{sdblock}



\end{sequencediagram}
\end{center}
\smallskip

Das RIS kann Informationen zu Buchungszielen abonnieren, um unmittelbar über Änderungen von Verfügbarkeiten informiert zu werden. Dies dient im Wesentlichen dazu, Reiseauskünfte ohne zusätzliche (synchrone) Anfrage an das FVS beantworten zu können.

Durch die initiale Anfrage \texttt{AvailabilitySubscriptionRequest} wird ein Abonnement (subscription) begonnen. Hierzu übergibt das RIS die entsprechende Buchungszielreferenz. Durch das Setzen des Flags Kündigung kann ein Abonnement storniert werden. Bei Änderungen an Verfügbarkeiten überträgt das FVS asynchron \texttt{AvailabilityPushMessage}s. Diese werden über den gleichen Kommunikationskanal geliefert, über den das Abonnement erstellt wurde. Beim Beenden des Kommunikationskanals werden alle Abonnements hinfällig.

Zur anfänglichen Synchronisierung aller Verfügbarkeiten kann das RIS die Funktion \texttt{Complete\-Availability\-Request} aufrufen.





\subsection*{Standortkapazitätabonnement (Dienst 3a)}
\label{subsec:Interaktionsprotokolle:Dienst3a}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{Standortkapazitäten abonnieren}{}

\begin{call}{ris}{Standortreferenz, (Kündigung)*}{fvs}{}
\end{call}

\end{sdblock}
\postlevel
\begin{sdblock}{Kapazitätsaktualisierungen}{}

\begin{mess}{fvs}{Standortkapazität}{ris}
\end{mess}

\begin{mess}{fvs}{Standortkapazität}{ris}
\end{mess}
\begin{mess}{fvs}{Standortkapazität}{ris}
\end{mess}
\begin{mess}{fvs}{...}{ris}
\end{mess}
\end{sdblock}
\postlevel

\begin{sdblock}{Vollständige Standortkapazitäten}{}

\begin{call}{ris}{}{fvs}{Standortkapazitäten}
\end{call}

\end{sdblock}



\end{sequencediagram}
\end{center}
\smallskip

Das RIS kann die Kapazitätsinformation von Standorten abonnieren. Der Interaktionsablauf ist analog zu \cref{subsec:Interaktionsprotokolle:Dienst3}.


\section{Dienst 4 -- Buchung / Buchungsänderung}
\label{sec:Interaktionsprotokolle:Dienst4}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

% \begin{sdblock}{OpenSession*}{}
%
% \begin{call}{ris}{}{fvs}{}
% \end{call}
%
% \end{sdblock}


\begin{sdblock}{Buchung}{}

\begin{call}{ris}{Buchungszielreferenz, Zeitraumvorschlag}{fvs}{Buchungsreferenz, Zeitraum}
\end{call}

\end{sdblock}
\postlevel

\begin{sdblock}{Buchungsänderung*}{}

\begin{call}{ris}{Vorschlag für neuen Zeitraum / Stornierung}{fvs}{Zeitraum}
\end{call}

\end{sdblock}

% \begin{sdblock}{CloseSession*}{}
%
% \begin{call}{ris}{}{fvs}{}
% \end{call}
%
% \end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

Um im Kundenauftrag ein Fahrzeug zu buchen, ist es erforderlich, dass das RIS den Kunden gegenüber dem FVS authentifizert. Hierzu gibt es drei Möglichkeiten, die in \cref{sec:Datenmodell:Auth} genauer dargestellt sind. In diesem Beispiel wird explizit eine Sitzung geöffnet und im Anschluss an die Transaktion wieder geschlossen. Danach kann eine Buchung durch den Aufruf von \texttt{Booking} mit Angabe der entsprechenden Buchungsziel ID und einem Vorschlag für einen Zeitraum durchgeführt werden. \blockquote{Vorschlag} deshalb, da das FVS z.\,B. den Zeitraum auf das verwendete Buchungsraster ändern kann. Als Antwort wird die verwendete Buchungsreferenz und der tatsächliche Buchungszeitraum zurückgegeben. Die Buchungsreferenz kann zur Überwachung der Buchung verwendet werden (vgl. \cref{sec:Interaktionsprotokolle:Dienst5}). Zur Änderung des Buchungszeitraums oder zur Stornierung kann \texttt{ChangeBooking} aufgerufen werden. Bei Änderung des Buchungsziels ist eine Stornierung und Neubuchung erforderlich.


\section{Dienst 5 --  Buchungsabonnement}
\label{sec:Interaktionsprotokolle:Dienst5}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{Buchungsabonnement}{}

\begin{call}{ris}{Buchungsreferenz, (Abostornierung)*}{fvs}{}
\end{call}

\end{sdblock}
\postlevel
\begin{sdblock}{Buchungsänderungen}{}

\begin{mess}{fvs}{Buchungsänderung}{ris}
\end{mess}

\begin{mess}{fvs}{Buchungsänderung}{ris}
\end{mess}
\begin{mess}{fvs}{Buchungsänderung}{ris}
\end{mess}
\begin{mess}{fvs}{...}{ris}
\end{mess}
\end{sdblock}
\postlevel

\begin{sdblock}{Vollständige Buchungsinformation}{}

\begin{call}{ris}{}{fvs}{Buchungsänderungen}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

Das RIS kann Änderungen an Buchungen abonnieren, um diese Informationen dem Kunden weiterzugeben und ggfs. Alternativen anzubieten. Beispielsweise im Falle eines technischen Defekts an einem Fahrzeug kann das FVS das RIS darüber informieren, dass die Buchung nicht mehr möglich ist. Ebenfalls ist es möglich, eine Buchung als \blockquote{wieder möglich} festzulegen. Endgültig storniert werden kann eine Buchung nur vom Endkunden.

Der Interaktionsablauf ist analog zu \cref{subsec:Interaktionsprotokolle:Dienst3}.


\section{Dienst 6 -- Preisauskunft}
\label{sec:Interaktionsprotokolle:Dienst6}

% \subsection{Abfrage Preis}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

% \begin{sdblock}{OpenSession*}{}
%
% \begin{call}{ris}{}{fvs}{}
% \end{call}
%
% \end{sdblock}

\begin{sdblock}{Preisauskunft}{}

\begin{call}{ris}{Buchungszielreferenz, Vorschlag Zeitraum, Distanz}{fvs}{Preis}

\end{call}

\end{sdblock}

% \begin{sdblock}{EndSession*}{}
%
% \begin{call}{ris}{}{fvs}{}
% \end{call}
%
% \end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

Mit einer Anfrage \texttt{PriceInformationRequest} kann das RIS beim FVS eine Preisauskunft auf Basis von Buchungsziel ID, Zeitraum und zurückzulegende Distanz anfragen. Falls vorher eine Authentifizierung des Endkunden z.\,B. durch \texttt{OpenSession} stattgefunden hat, ist die Preisanfrage entsprechend des Kundenvertrags zu beantworten.
