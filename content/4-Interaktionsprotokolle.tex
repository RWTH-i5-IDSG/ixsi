\chapter{Interaction Sequences}
\label{cha:Interaktionsprotokolle}
This section provides an overview about the interaction schemes, used by IXSI. For simplification, these interaction schemes are described in interaction sequence diagrams without using the technical terms of function calls. In principal, two types of interactions are used: The simple and well-known request/response- or. query- interaction scheme, whereby every call of the client (in this case TIS) is followed by exactly one response of the server (VRS). Furthermore, the subscription-scheme, whereby one object is subscribed by the client once and updated continuously by the server. Hereby, the communication channel is opened all the time. 

\section{Overview}
The following sequence diagram gives an exemplary overview of information coupling, possibly enabled by IXSI. The used services are going to be described in detail in the following chapters. In this use case, a customer sets up a travel inquiry, books a respective travel and gets informed concerning relevant booking changes. 

In the first block \textit{Exchange booking targets}, the booking targets, provided by the \index{VRS}VRS are exchanged with the \index{TIS}TIS and relevant booking targets are subscribed (see. \cref{sec:Interaktionsprotokolle:Dienst1,sec:Interaktionsprotokolle:Dienst3}). This happens proactive, without involving the customer.
In block \textit{Travel Inquiry}, a customer sets up a travel inquiry with, e.g. his mobile device, on the TIS. Thereby, various rental vehicles are suitable for booking, whose availabilities are requested synchronously towards the VRS. For availabilities, the TIS additionally requests price information. As a result, the TIS provides a selection of possible routes/ connections to the customer. Because this is a communication triggered by the customer, a session which proceeds the queries is created implicitly. An anonymous session is used, because the customer did not register on his device beforehand.
In block \textit{Tarvel booking}, a customer has chosen a travel route and intends to book it. For this purpose, he registers on his mobile device, whereby a token is generated(Block \emph{Registration}). With this token, a (not anonymous) session is created, which proceeds the booking operation. For that, the TIS forwards booking reference and a time proposal to the VRS. This sends a booking confirmation, which is forwarded to the customer. In addition, the TIS subscribes the respective booking on the VRS.
In the last block \textit{Travel monitoring}, the customers gets informed concerning booking changes, which are received by the TIS, coming from the VRS.
\begin{center}
\begin{sequencediagram}


\newthread{customer}{:Customer}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}


\begin{sdblock}{Exchange booking targets}{Service 1, Service 3}

  \begin{call}{tis}{Request}{vrs}{List booking targets}
  \end{call}

  \begin{call}{tis}{Subscription booking targets}{vrs}{}
  \end{call}
  
  \begin{mess}{vrs}{Change booking target}{tis}
  \end{mess}
\end{sdblock}
\postlevel

\begin{sdblock}{Travel inquiry}{}
  \begin{call}{customer}{Travel inquiry}{tis}{Possible routes}

    \begin{sdblock}{Session (anonymous)}{Base service A}
        
        \begin{sdblock}{Availability information}{Service 2}
          \begin{call}{tis}{Availability information booking targets,  time span}{vrs}{Possible booking targets}
          \end{call}
        \end{sdblock}

        \begin{sdblock}{Price inquiry}{Service 6}
          \begin{call}{tis}{Price information booking targets, time span, distance}{vrs}{Price}
          \end{call}
        \end{sdblock}

    \end{sdblock}
  \end{call}
\end{sdblock}

\end{sequencediagram}

\smallskip


\begin{sequencediagram}
\newthread{customer}{:Customer}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Registration}{}

  \begin{call}{customer}{Registration}{tis}{Token}
        
    \begin{sdblock}{Token generation}{Base service C}


      \begin{call}{tis}{User name, password}{vrs}{Token}
      \end{call}

    \end{sdblock}

  \end{call}
\end{sdblock}
\postlevel

\begin{sdblock}{Travel booking}{}

  \begin{call}{customer}{Route selection, token}{tis}{Booking confirmation}
    \begin{sdblock}{Session}{Base service A}

      \begin{sdblock}{Vehicle booking}{Service 4}
        \begin{call}{tis}{Booking target reference, time span proposal}{vrs}{booking reference, time span}
        \end{call}
      \end{sdblock}

    \end{sdblock}

  \end{call}
    
    \begin{sdblock}{Booking subscription}{Service 5}

      \begin{call}{tis}{Booking reference}{vrs}{}
      \end{call}

    \end{sdblock}

    \begin{sdblock}{Verbrauchsdatenabonnement}{Dienst 7}

      \begin{call}{tis}{Buchungsreferenz}{vrs}{}
      \end{call}

    \end{sdblock}



\end{sdblock}



\end{sequencediagram}
\end{center}
\smallskip

\begin{center}

\begin{sequencediagram}
\newthread{kunde}{:Kunde}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\postlevel

\begin{sdblock}{Travel monitoring}{Service 5}
\postlevel
  \begin{mess}{vrs}{Booking change}{tis}
  \end{mess}
	      
  \begin{mess}{tis}{Booking change}{customer}
  \end{mess}

\end{sdblock}

\begin{sdblock}{Abrechnung}{Dienst 7}
\postlevel
\begin{mess}{fvs}{Verbrauchsdaten}{ris}
\end{mess}

\begin{mess}{ris}{Rechnung}{kunde}
\end{mess}

\end{sdblock}

\end{sequencediagram}
\end{center}

\smallskip


\section{Service 1 -- Static Data}
\label{sec:Interaktionsprotokolle:Dienst1}

\subsection*{Booking Target Query}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Booking target exchange}{}

\begin{call}{tis}{Booking target query(Provider*)}{vrs}{Booking target list}

\end{call}

\end{sdblock}

\end{sequencediagram}\\
\hfill\textit{* optional}
\end{center}
\smallskip

Basis for information coupling is the exchange of booking targets. Booking targets are a logical representation of one or several vehicles with common characteristics, e.g., provided by the same provider, same vehicle type or same rental station. These characteristics are statically. To receive booking target information concerning a certain provider solely, it is possible to filter concerning the respective provider. The transmission is initiated by the TIS.

\subsection*{Booking Target Change Query}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Booking Target Changes}{}

\begin{call}{tis}{Booking target change query}{vrs}{Provider list}
\end{call}

% \begin{messcall}{ris}{Asynchrone Nachricht}{fvs}
% \end{messcall}

\end{sdblock}
\end{sequencediagram}
\end{center}
\smallskip

To avoid the transmission of all booking information per interval, with the help of the query \texttt{ChangedProviders} it is possible to request the provider, related to changes since a specific point in time, set by the parameter \texttt{timestamp}. A provider reference is returned, which in turn can be transferred as a parameter by the function call \texttt{Booking\-TargetsInfo}. 

\section{Service 2 -- Availability Information}
\label{sec:Interaktionsprotokolle:Dienst2}

\subsection*{Availability Query}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Availability Information}{}

\begin{call}{tis}{Booking targets/ area, time span}{vrs}{Booking targets}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

To request specific availabilities, the TIS sends a query, which either contains a list of booking targets or a geographic area in form of a proximity search or as a rectangle and a required time period. Without specification, the availabilities of all booking targets are returned. As a response, the VRS returns a list of booking targets and their availabilities. 

\subsection*{Current Station Capacity Query (Service 2a)}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Station Capacity Query}{}

\begin{call}{tis}{Station reference/ area}{vrs}{List of station capacities}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip
The TIS is able to request current capacities from rental stations, e.g., for map illustration. For this purpose, a list containing station IDs or an area has to be transferred. As a response, a list of locations and their current amount of available vehicles is returned.

\section{Service 3 -- Availability Subscription}
\label{sec:Interaktionsprotokolle:Dienst3}


\subsection*{Availability Subscription}
\label{subsec:Interaktionsprotokolle:Dienst3}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Subscribe availabilities}{}

\begin{call}{tis}{Booking target, (cancellation)*, time horizon}{vrs}{}
\end{call}

\end{sdblock}
\postlevel
\begin{sdblock}{Availability updates}{}

\begin{mess}{vrs}{Availability update}{tis}
\end{mess}
\begin{mess}{vrs}{Availability update}{tis}
\end{mess}
\begin{mess}{vrs}{Availability update}{tis}
\end{mess}
\begin{mess}{vrs}{...}{tis}
\end{mess}
\end{sdblock}

\postlevel
\begin{sdblock}{Overall availability}{}

\begin{call}{tis}{Maximum amount of objects}{vrs}{Booking targets}
\end{call}

\end{sdblock}



\end{sequencediagram}
\end{center}
\smallskip

The TIS can subscribe to information concerning booking targets to get informed about availability changes immediately. In Principal, this serves to enable responses to travel inquiries without additional (synchronous) requests towards the VRS.

Through the initial query \texttt{AvailabilitySubscriptionRequest} a subscription is started. For this purpose, the TIS forwards the related booking reference. By setting the flag "Cancellation", a subscription can be canceled. In case of changes concerning availabilities, the VRS forwards asynchronously \texttt{AvailabilityPushMessage}. These a delivered via the same communication channel as upon the subscription was created beforehand. By cancellation of the communication channel, all subscriptions turn to be obsolete.


\subsection*{Location Capacity Subscription (Service 3a)}
\label{subsec:Interaktionsprotokolle:Dienst3a}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Subscribe Location Capacities}{}

\begin{call}{tis}{Location refernce, (Cancellation)*}{vrs}{}
\end{call}

\end{sdblock}
\postlevel
\begin{sdblock}{Capacity updates}{}

\begin{mess}{vrs}{Location capacity}{tis}
\end{mess}

\begin{mess}{vrs}{Location capacity}{tis}
\end{mess}
\begin{mess}{vrs}{Location capacity}{tis}
\end{mess}
\begin{mess}{vrs}{...}{tis}
\end{mess}
\end{sdblock}
\postlevel

\begin{sdblock}{Entire location capacities}{}

\begin{call}{tis}{}{vrs}{Location capacity}
\end{call}

\end{sdblock}



\end{sequencediagram}
\end{center}
\smallskip

The TIS can subscribe capacity information of locations. The interaction procedure is analogous to \cref{subsec:Interaktionsprotokolle:Dienst3}.


\section{Service 4 -- Booking/ Booking Change}
\label{sec:Interaktionsprotokolle:Dienst4}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

% \begin{sdblock}{OpenSession*}{}
%
% \begin{call}{ris}{}{fvs}{}
% \end{call}
%
% \end{sdblock}


\begin{sdblock}{Booking}{}

\begin{call}{tis}{Booking target reference, time span proposal}{vrs}{Booking reference, time span}
\end{call}

\end{sdblock}
\postlevel

\begin{sdblock}{Booking change*}{}

\begin{call}{tis}{Proposal for new time span / Cancellation}{vrs}{Time span}
\end{call}

\end{sdblock}

% \begin{sdblock}{CloseSession*}{}
%
% \begin{call}{ris}{}{fvs}{}
% \end{call}
%
% \end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

\subsection*{Subscription external bookings (Service 4a)}
\label{subsec:Interaktionsprotokolle:Dienst4a}

\begin{center}
	\begin{sequencediagram}
		\newthread{tis}{:TIS}
		\newinst[8]{vrs}{:VRS}

		\begin{sdblock}{Subscription external bookings}{}

			\begin{call}{tis}{Customer reference, (Subscription cancellation)*}{vrs}{}
			\end{call}

		\end{sdblock}
		\postlevel
		\begin{sdblock}{External booking}{}

			\begin{mess}{vrs}{External booking}{tis}
			\end{mess}

			\begin{mess}{vrs}{External booking}{tis}
			\end{mess}
			\begin{mess}{vrs}{External booking}{tis}
			\end{mess}
			\begin{mess}{vrs}{...}{tis}
			\end{mess}
		\end{sdblock}
		\postlevel

		\begin{sdblock}{Complete external booking}{}

			\begin{call}{tis}{}{vrs}{External bookings}
			\end{call}

		\end{sdblock}

	\end{sequencediagram}
\end{center}
\smallskip


To book a vehicle in customer order, it is necessary that the TIS authenticates the customers towards the VRS. For this purpose, there are three possibilities, further specified in \cref{sec:Datenmodell:Auth} In this example, a session is opened explicitly and closed after the transaction. After that, a booking can utilized by calling \texttt{Booking} with provision of the respective booking target ID and a time span proposal. \blockquote{Vorschlag} because the VRS is able to change the time span to the used booking grid. As response, the used booking reference and the actual time span is returned. The booking reference can be used for monitoring of the booking (see \cref{sec:Interaktionsprotokolle:Dienst5}). For changes of the booking time span or for cancellation, \texttt{ChangeBooking} can be called. In case of changes of the booking target, a cancellation or a new booking becomes necessary.

\section{Service 5 --  Booking Subscription}
\label{sec:Interaktionsprotokolle:Dienst5}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Booking subscription}{}

\begin{call}{tis}{Booking reference, (Subscription cancellation)*}{vrs}{}
\end{call}

\end{sdblock}
\postlevel
\begin{sdblock}{Booking changes}{}

\begin{mess}{vrs}{Booking change}{tis}
\end{mess}

\begin{mess}{vrs}{Booking change}{tis}
\end{mess}
\begin{mess}{vrs}{Booking change}{tis}
\end{mess}
\begin{mess}{vrs}{...}{tis}
\end{mess}
\end{sdblock}
\postlevel

\begin{sdblock}{Complete Booking Information}{}

\begin{call}{tis}{}{vrs}{Booking changes}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

The TIS can subscribe to changes concerning bookings to provide this information to customers and probably propose alternatives. For example in case of an technical failure of a vehicle, the VRS can inform the TIS that a booking is not longer possible. In addition, it is possible to set a booking to \blockquote{possible again}. The booking can be canceled ultimately only by the customer himself. 

The interaction procedure is analogous to \cref{subsec:Interaktionsprotokolle:Dienst3}.


\section{Service 6 -- Price Information}
\label{sec:Interaktionsprotokolle:Dienst6}

% \subsection{Abfrage Preis}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

% \begin{sdblock}{OpenSession*}{}
%
% \begin{call}{ris}{}{fvs}{}
% \end{call}
%
% \end{sdblock}

\begin{sdblock}{Price information}{}

\begin{call}{tis}{Booking target reference, time span proposal, distance}{vrs}{Price}

\end{call}

\end{sdblock}

% \begin{sdblock}{EndSession*}{}
%
% \begin{call}{ris}{}{fvs}{}
% \end{call}
%
% \end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

With the query \texttt{PriceInformationRequest}, the TIS can request price information towards the VRS on the basis of booking target ID, time span and traveled distance. In case of a customer authentication through \texttt{OpenSession} took place beforehand, the price request has to be replied-to accordingly to the customer contract.



\section{Dienst 7 --  Verbrauchsdatenabonnement}
\label{sec:Interaktionsprotokolle:Dienst7}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{Verbrauchsdatenabonnement}{}

\begin{call}{ris}{Buchungsreferenz, (Abostornierung)*}{fvs}{}
\end{call}

\end{sdblock}
\postlevel
\begin{sdblock}{Verbrauchsdaten}{}

\begin{mess}{fvs}{Verbrauchsdaten}{ris}
\end{mess}

\begin{mess}{fvs}{Verbrauchsdaten}{ris}
\end{mess}

\begin{mess}{fvs}{Verbrauchsdaten}{ris}
\end{mess}

\begin{mess}{fvs}{...}{ris}
\end{mess}
\end{sdblock}
\postlevel

\begin{sdblock}{Vollständige Verbrauchsdaten}{}

\begin{call}{ris}{}{fvs}{Verbrauchsdaten}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

Das RIS kann Verbrauchsdaten (Nutzungsdauer, Entfernung, ggfs. andere) für eine Buchung abonnieren. Sobald neue Verbrauchsdaten vorliegen (z.\,B. bei Rückgabe eines Fahrzeuges) informiert das FVS das RIS über den vorliegenden Verbrauch. Zu einer Buchung können mehrere Informationen zu Verbrauchsdaten versendet werden. Neue Verbrauchsdaten zu einer Buchung invalidieren alle vorherigen und müssen entsprechend vollständig sein.

Der Interaktionsablauf ist analog zu \cref{subsec:Interaktionsprotokolle:Dienst3}.


\section{Dienst 8 -- Buchungsstatus ändern}
\label{sec:Interaktionsprotokolle:Dienst8}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}



\begin{sdblock}{Sitzung}{Basisdienst A}

  \begin{sdblock}{Fahrzeugbuchung}{Dienst 4}
  \begin{call}{ris}{Buchungszielreferenz}{fvs}{Buchungsreferenz, Vorschlag Zeitraum}
    \end{call}
  \end{sdblock}

  \begin{sdblock}{Buchungsstatus ändern}{Dienst 8}
  \begin{call}{ris}{Buchungsreferenz, Buchungsstatus}{fvs}{Zusatzinformationen}
    \end{call}
  \end{sdblock}

\end{sdblock}


\end{sequencediagram}
\end{center}
\smallskip

Um ein Buchungsziel (Fahrzeug bzw. Schlüsselkasten) durch das RIS freischalten zu lassen, muss eine Buchung für dieses Buchungsziel bereits vorliegen (diese muss ggfs. für den Nutzer transparent durchgeführt werden). Mit einer Referenz auf diese Buchung kann das Buchungsziel dann freigeschaltet werden. Eine Authentifizierung ist hierfür erforderlich. Pausieren und Abschließen einer Buchung passiert analog.



\section{Dienst 9 -- Benutzermanagement}
\label{sec:Interaktionsprotokolle:Dienst9}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}


\begin{sdblock}{Benutzer erstellen}{Dienst 9}
\begin{call}{ris}{Benutzerinformation}{fvs}{}
\end{call}
\end{sdblock}

\begin{sdblock}{Benutzer sperren}{Dienst 9}
\begin{call}{ris}{Benutzerreferenz, sperren/entsperren}{fvs}{}
\end{call}
\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

Das RIS legt Benutzer im FVS an, um eine doppelte Anmeldung bei beiden Diensten überflüssig zu machen. Optional können Benutzer auch gesperrt/entsperrt werden.



\section{Dienst 10 --  Fahrzeugseinstellungsmanagement}
\label{sec:Interaktionsprotokolle:Dienst10}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{Einstellungsabonnement}{}

\begin{call}{ris}{Buchungsreferenz, (Abostornierung)*}{fvs}{}
\end{call}

\end{sdblock}
\postlevel
\begin{sdblock}{Fahrzeugeinstellungen}{}

\begin{mess}{fvs}{Fahrzeugeinstellungen}{ris}
\end{mess}

\begin{mess}{fvs}{...}{ris}
\end{mess}
\end{sdblock}
\postlevel

\begin{sdblock}{Fahrzeugeinstellungen senden}{}

\begin{call}{ris}{}{fvs}{Buchungsreferenz, Fahrzeugeinstellungen}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

Das RIS kann Buchungs bzw. Fahrzeugeinstellungen beim FVS abonnieren.
Nach einer abgeschlossenen Buchung (oder in intervallen) übermittelt das FVS die durch den Benutzer durchgeführten Fahrzeugeinstellungen wie Sitzposition, Zieltemperatur der Klimaanlage, eingestellter Radiosender usw.
Kurz vor dem Start einer Folgebuchung kann das RIS dann wiederrum Fahrzeugeinstellung übermitteln damit der Benutzer bei betreten des Fahrzeugs die gleiche Konfiguration wie vorher wiederfindet.



\section{Dienst 11 -- Fernkonfiguration Navigationssystem und Fahrtverlauf überwachen}
\label{sec:Interaktionsprotokolle:Dienst11}

\begin{center}
\begin{sequencediagram}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\begin{sdblock}{Fernkonfiguration Navigationssystem}{}
\begin{call}{ris}{Buchungsreferenz, Zielort}{fvs}{}
  \end{call}
\end{sdblock}
\postlevel
  
\begin{sdblock}{Fahrtverlauf überwachen}{}

\begin{call}{ris}{Buchungsreferenz, (Abostornierung)*}{fvs}{}
\end{call}

\end{sdblock}

\begin{sdblock}{Fahrtverlauf}{}

\begin{mess}{fvs}{Position / vorraus. Ankunftszeit}{ris}
\end{mess}

\begin{mess}{fvs}{Position / vorraus. Ankunftszeit}{ris}
\end{mess}

\begin{mess}{fvs}{Position / vorraus. Ankunftszeit}{ris}
\end{mess}

\begin{mess}{fvs}{Bestätigung Ankunft}{ris}
\end{mess}
\end{sdblock}
\postlevel

\end{sequencediagram}
\end{center}
\smallskip

Das RIS kann nach der Buchung dem Fahrzeug den Zielort übermitteln (Fernkonfiguration Navigationssystem), so dass der Reisende den Zielort nicht selbst eingeben muss. 
Außerdem kann das RIS den Fortschritt der Fahrt abonnieren, und wird dann fortlaufend vom FVS über Änderungen der Position und der vorraussichtlichen Ankunftszeit informiert.
