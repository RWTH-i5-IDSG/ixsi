\chapter{Interaction Sequences}
\label{cha:Interaktionsprotokolle}
This section provides an overview about the interaction schemes, used by IXSI. For simplification, these interaction schemes are described by interaction sequence diagrams without using the technical terms of function calls. In principle, two types of interactions are used: The simple and well-known request/response- or the query- interaction scheme, whereby every call of the client (in this case TIS) is followed by exactly one response of the server (VRS). Furthermore, the subscription-scheme, whereby one object is subscribed by the client once and updated continuously by the server. Hereby, the communication channel is opened all the time. 

\section{Overview}
The following sequence diagram gives an exemplary overview of information coupling, possibly enabled by IXSI. The used services are going to be described in detail in the following chapters. In this use case, a customer sets up a travel inquiry, books a respective travel and gets informed concerning relevant booking changes. 

In the first block \textit{Exchange booking targets}, the booking targets, provided by the \index{VRS}VRS are exchanged with the \index{TIS}TIS and relevant booking targets are subscribed (see. \cref{sec:Interaktionsprotokolle:Dienst1,sec:Interaktionsprotokolle:Dienst3}). This happens proactive, without involving the customer.
In block \textit{Travel Inquiry}, a customer sets up a travel inquiry with e.g., his mobile device, on the TIS. Thereby, various rental vehicles are suitable for booking, whose availabilities are requested synchronously towards the VRS. The TIS additionally requests price information for available vehicles. As a result, the TIS provides a selection of possible routes / connections to the customer. Since this is a communication triggered by the customer, a session which proceeds the queries is created implicitly. An anonymous session is used, because the customer did not register on his device beforehand.
In block \textit{Travel booking}, a customer has chosen a travel route and intends to book it. For this purpose, he registers on his mobile device, whereby a token is generated (Block \emph{Registration}). With this token, a (not anonymous) session is created, which proceeds the booking operation. For that, the TIS forwards booking reference and a time proposal to the VRS. This sends a booking confirmation, which is forwarded from the TIS to the customer. In addition, the TIS subscribes the respective booking on the VRS.
In the last block \textit{Travel monitoring}, the customer gets informed concerning booking changes, which are received by the TIS, coming from the VRS.
\begin{center}
\begin{sequencediagram}


\newthread{customer}{:Customer}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}


\begin{sdblock}{Exchange booking targets}{Service 1, Service 3}

  \begin{call}{tis}{Request}{vrs}{List booking targets}
  \end{call}

  \begin{call}{tis}{Subscription booking targets}{vrs}{}
  \end{call}
  
  \begin{mess}{vrs}{Change booking target}{tis}
  \end{mess}
\end{sdblock}
\postlevel

\begin{sdblock}{Travel inquiry}{}
  \begin{call}{customer}{Travel inquiry}{tis}{Possible routes}

    \begin{sdblock}{Session (anonymous)}{Base service A}
        
        \begin{sdblock}{Availability information}{Service 2}
          \begin{call}{tis}{Availability information booking targets,  time span}{vrs}{Possible booking targets}
          \end{call}
        \end{sdblock}

        \begin{sdblock}{Price inquiry}{Service 6}
          \begin{call}{tis}{Price information booking targets, time span, distance}{vrs}{Price}
          \end{call}
        \end{sdblock}

    \end{sdblock}
  \end{call}
\end{sdblock}

\end{sequencediagram}

\smallskip


\begin{sequencediagram}
\newthread{customer}{:Customer}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Registration}{}

  \begin{call}{customer}{Registration}{tis}{Token}
        
    \begin{sdblock}{Token generation}{Base service C}


      \begin{call}{tis}{User name, password}{vrs}{Token}
      \end{call}

    \end{sdblock}

  \end{call}
\end{sdblock}
\postlevel

\begin{sdblock}{Travel booking}{}

  \begin{call}{customer}{Route selection, token}{tis}{Booking confirmation}
    \begin{sdblock}{Session}{Base service A}

      \begin{sdblock}{Vehicle booking}{Service 4}
        \begin{call}{tis}{Booking target reference, time span proposal}{vrs}{booking reference, time span}
        \end{call}
      \end{sdblock}

    \end{sdblock}

  \end{call}
    
    \begin{sdblock}{Booking subscription}{Service 5}

      \begin{call}{tis}{Booking reference}{vrs}{}
      \end{call}

    \end{sdblock}

    \begin{sdblock}{Verbrauchsdatenabonnement}{Dienst 7}

      \begin{call}{tis}{Booking reference}{vrs}{}
      \end{call}

    \end{sdblock}



\end{sdblock}



\end{sequencediagram}
\end{center}
\smallskip

\begin{center}

\begin{sequencediagram}
\newthread{kunde}{:Kunde}
\newthread{ris}{:RIS}
\newinst[8]{fvs}{:FVS}

\postlevel

\begin{sdblock}{Travel monitoring}{Service 5}
\postlevel
  \begin{mess}{vrs}{Booking change}{tis}
  \end{mess}
	      
  \begin{mess}{tis}{Booking change}{customer}
  \end{mess}

\end{sdblock}

\begin{sdblock}{Abrechnung}{Dienst 7}
\postlevel
\begin{mess}{fvs}{Verbrauchsdaten}{ris}
\end{mess}

\begin{mess}{ris}{Rechnung}{kunde}
\end{mess}

\end{sdblock}

\end{sequencediagram}
\end{center}

\smallskip


\section{Service 1 -- Static Data}
\label{sec:Interaktionsprotokolle:Dienst1}

\subsection*{Booking Target Query}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Booking target exchange}{}

\begin{call}{tis}{Booking target query(Provider*)}{vrs}{Booking target list}

\end{call}

\end{sdblock}

\end{sequencediagram}\\
\hfill\textit{* optional}
\end{center}
\smallskip

Basis for information coupling is the exchange of booking targets. Booking targets are a logical representation of one or several vehicles with common characteristics, e.g., provided by the same provider, same vehicle type or same rental station. These characteristics are static. To receive booking target information concerning a certain provider solely, it is possible to filter concerning the respective provider. The transmission is initiated by the TIS.

\subsection*{Booking Target Change Query}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Booking Target Changes}{}

\begin{call}{tis}{Booking target change query}{vrs}{Provider list}
\end{call}

% \begin{messcall}{ris}{Asynchrone Nachricht}{fvs}
% \end{messcall}

\end{sdblock}
\end{sequencediagram}
\end{center}
\smallskip

To avoid the transmission of all booking information per interval, with the help of the query \texttt{ChangedProviders} it is possible to request the provider, related to changes since a specific point in time, set by the parameter \texttt{timestamp}. A provider reference is returned, which in turn can be transferred as a parameter by the function call \texttt{Booking\-TargetsInfo}. 

\section{Service 2 -- Availability Information}
\label{sec:Interaktionsprotokolle:Dienst2}

\subsection*{Availability Query}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Availability Information}{}

\begin{call}{tis}{Booking targets/ area, time span}{vrs}{Booking targets}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

To request specific availabilities, the TIS sends a query, which either contains a list of booking targets or a geographic area in form of a proximity search or as a rectangle and a required time period. Without specification, the availabilities of all booking targets are returned. As a response, the VRS returns a list of booking targets and their availabilities. 

\subsection*{Current Station Capacity Query (Service 2a)}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Station Capacity Query}{}

\begin{call}{tis}{Station reference/ area}{vrs}{List of station capacities}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip
The TIS is able to request current capacities from rental stations, e.g., for map illustration. For this purpose, a list containing station IDs or an area has to be transferred. As a response, a list of locations and their current amount of available vehicles is returned.

\section{Service 3 -- Availability Subscription}
\label{sec:Interaktionsprotokolle:Dienst3}


\subsection*{Availability Subscription}
\label{subsec:Interaktionsprotokolle:Dienst3}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Subscribe availabilities}{}

\begin{call}{tis}{Booking target, (cancellation)*, time horizon}{vrs}{}
\end{call}

\end{sdblock}
\postlevel
\begin{sdblock}{Availability updates}{}

\begin{mess}{vrs}{Availability update}{tis}
\end{mess}
\begin{mess}{vrs}{Availability update}{tis}
\end{mess}
\begin{mess}{vrs}{Availability update}{tis}
\end{mess}
\begin{mess}{vrs}{...}{tis}
\end{mess}
\end{sdblock}

\postlevel
\begin{sdblock}{Overall availability}{}

\begin{call}{tis}{Maximum amount of objects}{vrs}{Booking targets}
\end{call}

\end{sdblock}



\end{sequencediagram}
\end{center}
\smallskip

The TIS can subscribe to information concerning booking targets to get informed about availability changes immediately. In principle, this serves to enable responses to travel inquiries without additional (synchronous) requests towards the VRS.

Through the initial query \texttt{AvailabilitySubscriptionRequest} a subscription is started. For this purpose, the TIS forwards the related booking reference. A subscription can be canceled, by setting the flag "Cancellation". In case of changes concerning availabilities, the VRS forwards asynchronously \texttt{AvailabilityPushMessage}. These are delivered via the same communication channel as upon the subscription was created beforehand. By cancellation of the communication channel, all subscriptions become obsolete.

For the initial synchronization of the availabilites the TIS can call the function \texttt{Complete\-Availability\-Request}.


\subsection*{Location Capacity Subscription (Service 3a)}
\label{subsec:Interaktionsprotokolle:Dienst3a}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Subscribe Location Capacities}{}

\begin{call}{tis}{Location refernce, (Cancellation)*}{vrs}{}
\end{call}

\end{sdblock}
\postlevel
\begin{sdblock}{Capacity updates}{}

\begin{mess}{vrs}{Location capacity}{tis}
\end{mess}

\begin{mess}{vrs}{Location capacity}{tis}
\end{mess}
\begin{mess}{vrs}{Location capacity}{tis}
\end{mess}
\begin{mess}{vrs}{...}{tis}
\end{mess}
\end{sdblock}
\postlevel

\begin{sdblock}{Entire location capacities}{}

\begin{call}{tis}{}{vrs}{Location capacity}
\end{call}

\end{sdblock}



\end{sequencediagram}
\end{center}
\smallskip

The TIS can subscribe capacity information of locations. The interaction procedure is analogous to \cref{subsec:Interaktionsprotokolle:Dienst3}.


\section{Service 4 -- Booking/ Booking Change}
\label{sec:Interaktionsprotokolle:Dienst4}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

% \begin{sdblock}{OpenSession*}{}
%
% \begin{call}{ris}{}{fvs}{}
% \end{call}
%
% \end{sdblock}


\begin{sdblock}{Booking}{}

\begin{call}{tis}{Booking target reference, time span proposal}{vrs}{Booking reference, time span}
\end{call}

\end{sdblock}
\postlevel

\begin{sdblock}{Booking change*}{}

\begin{call}{tis}{Proposal for new time span / Cancellation}{vrs}{Time span}
\end{call}

\end{sdblock}

% \begin{sdblock}{CloseSession*}{}
%
% \begin{call}{ris}{}{fvs}{}
% \end{call}
%
% \end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

\subsection*{Subscription External Bookings (Service 4a)}
\label{subsec:Interaktionsprotokolle:Dienst4a}

\begin{center}
	\begin{sequencediagram}
		\newthread{tis}{:TIS}
		\newinst[8]{vrs}{:VRS}

		\begin{sdblock}{Subscription external bookings}{}

			\begin{call}{tis}{Customer reference, (Subscription cancellation)*}{vrs}{}
			\end{call}

		\end{sdblock}
		\postlevel
		\begin{sdblock}{External booking}{}

			\begin{mess}{vrs}{External booking}{tis}
			\end{mess}

			\begin{mess}{vrs}{External booking}{tis}
			\end{mess}
			\begin{mess}{vrs}{External booking}{tis}
			\end{mess}
			\begin{mess}{vrs}{...}{tis}
			\end{mess}
		\end{sdblock}
		\postlevel

		\begin{sdblock}{Complete external booking}{}

			\begin{call}{tis}{}{vrs}{External bookings}
			\end{call}

		\end{sdblock}

	\end{sequencediagram}
\end{center}
\smallskip


To book a vehicle in customer order, it is necessary that the TIS authenticates the customers towards the VRS. For this purpose, there are three possibilities, which are further specified in \cref{sec:Datenmodell:Auth}. In this example, a session is opened explicitly and closed after the transaction. After that, a booking can be utilized by calling \texttt{Booking} with provision of the respective booking target ID and a time span proposal. \blockquote{Vorschlag} because the VRS is able to change the time span to the used booking grid. As response, the used booking reference and the actual time span is returned. The booking reference can be used for monitoring of the booking (see \cref{sec:Interaktionsprotokolle:Dienst5}). For changes of the booking time span or for cancellation, \texttt{ChangeBooking} can be called. In case of changes of the booking target, a cancellation or a new booking becomes necessary.

The TIS can subscribe to external bookings (e.g., directly at the station without assist of the TIS) of the VRS, in order to subscribe to booking changes or request corresponding consumption data. Therefore one or more customer references are handed over.

\section{Service 5 --  Booking Subscription}
\label{sec:Interaktionsprotokolle:Dienst5}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Booking subscription}{}

\begin{call}{tis}{Booking reference, (Subscription cancellation)*}{vrs}{}
\end{call}

\end{sdblock}
\postlevel
\begin{sdblock}{Booking changes}{}

\begin{mess}{vrs}{Booking change}{tis}
\end{mess}

\begin{mess}{vrs}{Booking change}{tis}
\end{mess}
\begin{mess}{vrs}{Booking change}{tis}
\end{mess}
\begin{mess}{vrs}{...}{tis}
\end{mess}
\end{sdblock}
\postlevel

\begin{sdblock}{Complete Booking Information}{}

\begin{call}{tis}{}{vrs}{Booking changes}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

The TIS can subscribe to changes concerning bookings to provide this information to customers and probably propose alternatives. For example in case of a technical failure of a vehicle, the VRS can inform the TIS that a booking is not longer possible. In addition, it is possible to set a booking to \blockquote{possible again}. Ultimately the booking can only be canceled customer himself. 

The interaction procedure is analogous to \cref{subsec:Interaktionsprotokolle:Dienst3}.


\section{Service 6 -- Price Information}
\label{sec:Interaktionsprotokolle:Dienst6}

% \subsection{Abfrage Preis}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

% \begin{sdblock}{OpenSession*}{}
%
% \begin{call}{ris}{}{fvs}{}
% \end{call}
%
% \end{sdblock}

\begin{sdblock}{Price information}{}

\begin{call}{tis}{Booking target reference, time span proposal, distance}{vrs}{Price}

\end{call}

\end{sdblock}

% \begin{sdblock}{EndSession*}{}
%
% \begin{call}{ris}{}{fvs}{}
% \end{call}
%
% \end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

With the query \texttt{PriceInformationRequest}, the TIS can request price information towards the VRS on the basis of booking target ID, time span and traveled distance. In case of a customer authentication e.g., through \texttt{OpenSession} took place beforehand, the price request has to be replied-to accordingly to the customer contract.



\section{Service 7 -- Subscription Consumption Data}
\label{sec:Interaktionsprotokolle:Dienst7}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Subscription consumption data}{}

\begin{call}{tis}{Booking reference, (Subscription cancellation)*}{vrs}{}
\end{call}

\end{sdblock}
\postlevel
\begin{sdblock}{Consumption data}{}

\begin{mess}{vrs}{Consumption data}{tis}
\end{mess}

\begin{mess}{vrs}{Consumption data}{tis}
\end{mess}

\begin{mess}{vrs}{Consumption data}{tis}
\end{mess}

\begin{mess}{vrs}{...}{tis}
\end{mess}
\end{sdblock}
\postlevel

\begin{sdblock}{Complete consumption data}{}

\begin{call}{tis}{}{vrs}{Consumption data}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

The TIS is able to subscribe for consumption data (e.g., usage duration, distance, others) for a booking. As soon as new consumption data occurs (e.g., by returning a vehicle), the VRS informs the TIS concerning the respective consumption. Concerning one booking, multiple consumption data information can be forwarded. New consumption datasets of one booking invalidate all previous datasets and accordingly need to be complete. 

The interaction sequence is analogous to \cref{subsec:Interaktionsprotokolle:Dienst3}.


\section{Service 8 -- Change Booking Status}
\label{sec:Interaktionsprotokolle:Dienst8}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}



\begin{sdblock}{Session}{Base service A}

  \begin{sdblock}{Vehicle booking}{Service 4}
  \begin{call}{tis}{Booking target reference}{vrs}{Booking reference, Proposal time span}
    \end{call}
  \end{sdblock}

  \begin{sdblock}{Change booking status}{Service 8}
  \begin{call}{tis}{Booking reference, Booking status}{vrs}{Additional information}
    \end{call}
  \end{sdblock}
\end{sdblock}


\end{sequencediagram}
\end{center}
\smallskip

To unlock a booking target (vehicle or key box) via the TIS, a booking for this booking target has to be present (probably this has to be proceeded in a transparent way towards the user). Using a reference for this booking, the booking target can be unlocked. Therefore, a authentication is mandatory. Pausing and finishing of a booking happens analogous. 

\section{Service 9 -- User Management}
\label{sec:Interaktionsprotokolle:Dienst9}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}


\begin{sdblock}{Create user}{Service 9}
\begin{call}{tis}{User information}{vrs}{}
\end{call}
\end{sdblock}

\begin{sdblock}{Lock user}{Service 9}
\begin{call}{tis}{User reference, lock/unlock}{vrs}{}
\end{call}
\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

The TIS creates user accounts in the VRS to avoid multiple registrations in both services. Optionally, users can be locked/unlocked, too.


\section{Service 10 --  Vehicle Setting Management}
\label{sec:Interaktionsprotokolle:Dienst10}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Settings subscription}{}

\begin{call}{tis}{Booking reference, (Subscription cancellation)*}{vrs}{}
\end{call}

\end{sdblock}
\postlevel
\begin{sdblock}{Vehicle settings}{}

\begin{mess}{vrs}{Vehicle settings}{tis}
\end{mess}

\begin{mess}{vrs}{...}{tis}
\end{mess}
\end{sdblock}
\postlevel

\begin{sdblock}{Sending vehicle settings}{}

\begin{call}{tis}{}{vrs}{Booking reference, vehicle settings}
\end{call}

\end{sdblock}

\end{sequencediagram}
\end{center}
\smallskip

The TIS is able to subscribe to booking or vehicle settings by the VRS. 
After a completed booking (or in intervals), the VRS transfers the vehicle setting, e.g., seat position, target temperature of the air condition, preferred radio stations, ... which were previously set by the user. 
Shortly before the beginning of a follow-up booking, the TIS is able to transfer vehicle settings, to provide the same vehicle configuration as before to the user.


\section{Service 11 -- Remote Configuration of Navigation System and Journey Progress Monitoring}
\label{sec:Interaktionsprotokolle:Dienst11}

\begin{center}
\begin{sequencediagram}
\newthread{tis}{:TIS}
\newinst[8]{vrs}{:VRS}

\begin{sdblock}{Remote configuration of navigation system}{}
\begin{call}{tis}{Booking reference, target location}{vrs}{}
  \end{call}
\end{sdblock}
\postlevel
  
\begin{sdblock}{Journey progress monitoring}{}

\begin{call}{tis}{Booking reference, (Subscription cancellation)*}{vrs}{}
\end{call}

\end{sdblock}

\begin{sdblock}{Journey progress}{}

\begin{mess}{vrs}{Position / estimated arrival time}{tis}
\end{mess}

\begin{mess}{vrs}{Position / estimated arrival time}{tis}
\end{mess}

\begin{mess}{vrs}{Position / estimated arrival time}{tis}
\end{mess}

\begin{mess}{vrs}{Confirmation arrival}{tis}
\end{mess}
\end{sdblock}
\postlevel

\end{sequencediagram}
\end{center}
\smallskip

After the booking, the TIS can transfer the target location to the vehicle (remote configuration navigation system), so that the traveler does not need to enter the target location by himself. 
Furthermore, the TIS can subscribe to the progress of a journey and then gets continuously informed by the VRS concerning changes of the position and the estimated arrival time. 
